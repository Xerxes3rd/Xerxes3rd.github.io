<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="description" content="WATL Leaderboards">
        <meta name="author" content="">

        <title>WATL Leaderboards</title>

        <!-- Bootstrap -->
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha384-HSMxcRTRxnN+Bdg0JdbxYKrThecOKuH5zCYotlSAcp1+c8xmyTe9GYg1l9a69psu" crossorigin="anonymous">

        <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
        <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
        <![endif]-->
        <style>
            .table-fixed th {
                position: sticky;
                position: -webkit-sticky;
                position: -moz-sticky;
                position: -ms-sticky;
                position: -o-sticky;
                top: 0;
                z-index: 999;
                background-color: #aaa;
                border-color: #aaa;
                border-bottom: 0px !important;
                border-top: 0px !important;
                transform: translate3d(0,0,0);
            }

            .table-fixed .th-lower {
                top: 38;
                height: 40;
                transform: translate3d(0,0,0);
            }

            .extra-bottom-padding {
                padding-bottom: 15px;
            }
        </style>
        <script>
            const weekClassName = "weekClass";
            const customExtraDataName = "customExtraData";
            
            var baseURL = "https://app.worldaxethrowingleague.com/api/";
            var leaderboardURL = baseURL + "player-leaderboard";
            var companiesURL = baseURL + "companies";
            var locationSeasonsURL = baseURL + "location-seasons";
            var seasonYearsURL = baseURL + "season-years";
            var locationWeeksURL = baseURL + "location-weeks";
            var locByWeeksURL = baseURL + "player-leaderboard-info-by-weeks";

            var companiesJSON;
            var companiesMap = {};
            var seasonsMap = {};
            var yearMap = {};
            var playerMap = {};
            var weekMap = {};

            var companiesSelectObj;
            var locationSelectObj;
            var seasonSelectObj;
            var yearSelectObj;
            var scoresTable;
            var scoresTableHeader;
            var scoresTableHeaderWeek;
            var scoresTableBody;
            var startingColumn;
            var numHeaderRows;
            var weekColumnHeader;

            var weekOrderHighLow = false;
            var showExtraColumns = false;
            var stickyHeaders = true;

            function parseQuery(search)
            {
                var args = search.substring(1).split('&');
                var argsParsed = {};
                var i, arg, kvp, key, value;

                for (i=0; i < args.length; i++) {
                    arg = args[i];
                    if (-1 === arg.indexOf('=')) {
                        argsParsed[decodeURIComponent(arg).trim()] = true;
                    }
                    else {
                        kvp = arg.split('=');
                        key = decodeURIComponent(kvp[0]).trim();
                        value = decodeURIComponent(kvp[1]).trim();
                        argsParsed[key] = value;
                    }
                }

                return argsParsed;
            }

            function buildQuery()
            {
                var queryString = "";
                var retval = "";

                var selectedCompany = getSelectedCompany();
                if (selectedCompany != null)
                {
                    queryString = queryString.concat((queryString.length > 0 ? "&" : "") + "companyid="+selectedCompany["id"]);
                }

                var selectedLocation = getSelectedLocation();
                if (selectedLocation != null)
                {
                    queryString = queryString.concat((queryString.length > 0 ? "&" : "") + "locationid="+selectedLocation["id"]);
                }

                var selectedSeason = getSelectedSeason();
                if (selectedSeason != null)
                {
                    queryString = queryString.concat((queryString.length > 0 ? "&" : "") + "seasonid="+selectedSeason["id"]);
                }

                var selectedYear = getSelectedYear();
                if (selectedYear != null)
                {
                    queryString = queryString.concat((queryString.length > 0 ? "&" : "") + "year="+selectedYear["year"]);
                }

                if (weekOrderHighLow)
                {
                    queryString = queryString.concat((queryString.length > 0 ? "&" : "") + "weekOrderHighLow="+weekOrderHighLow);
                }

                if (showExtraColumns)
                {
                    queryString = queryString.concat((queryString.length > 0 ? "&" : "") + "showExtraColumns="+showExtraColumns);
                }

                //if (stickyHeaders)
                //{
                //    queryString = queryString.concat((queryString.length > 0 ? "&" : "") + "sticky");
                //}

                if (queryString.length > 0)
                {
                    retval = "?" + queryString;
                }

                return retval;
            }

            function buildFullURL()
            {
                return window.location.origin + window.location.pathname + buildQuery();
            }

            function updateURL()
            {
                window.history.replaceState({}, 'Leaderboards', buildFullURL());
            }

            function onBodyLoad()
            {
                scoresTable = document.getElementById("scoresTable");
                companiesSelectObj = document.getElementById("companiesSelect");
                locationSelectObj = document.getElementById("locationSelect");
                seasonSelectObj = document.getElementById("seasonSelect");
                yearSelectObj = document.getElementById("yearSelect");
                scoresTableHeader = document.getElementById("scoresTableHeader");
                scoresTableBody = document.getElementById("scoresTableBody");
                scoresTableHeaderWeek = document.getElementById("scoresTableHeaderWeek");
                weekColumnHeader = document.getElementById("weekColumnHeader");
                numHeaderRows = scoresTable.rows.length;

                startingColumn = weekColumnHeader["cellIndex"];

                var search = parseQuery(window.location.search);
                if (("weekOrderHighLow" in search) &&
                    (search["weekOrderHighLow"] == "true"))
                {
                    weekOrderHighLow = true;
                }
                if (("showExtraColumns" in search) &&
                    (search["showExtraColumns"] == "true"))
                {
                    showExtraColumns = true;
                }
                
                //if ("sticky" in search)
                //{
                    toggleStickyHeaders(false);
                //}

                showHideExtraColumns();

                getCompanies();
            }

            function toggleStickyHeaders(triggerURLUpdate)
            {
                var enable = false;

                var tableDIV = document.getElementById("mainTableDIV");
                var selectorsDIV = document.getElementById("selectors");

                var node1;
                var node2;

                if (selectorsDIV.previousElementSibling == null)
                {
                    node1 = selectorsDIV;
                    node2 = tableDIV;
                }
                else if (tableDIV.previousElementSibling == null)
                {
                    node1 = tableDIV;
                    node2 = selectorsDIV;
                }

                if ((node1 != null) && (node2 != null))
                {
                    node1.parentNode.replaceChild(node1, node2);
                    node1.parentNode.insertBefore(node2, node1);

                    if (node1 == tableDIV)
                    {
                        document.getElementById("scoresTable").classList.remove("table-fixed");
                        stickyHeaders = false;
                    }
                    else
                    {
                        document.getElementById("scoresTable").classList.add("table-fixed");
                        stickyHeaders = true;
                    }

                    if (triggerURLUpdate)
                    {
                        updateURL();
                    }
                }
            }

            function showHideExtraColumns()
            {
                var extras = document.getElementsByClassName(customExtraDataName);
                //for (var i = 0; i < scoresTableHeader.children.length; i++)
                for (var i = 0; i < extras.length; i++)
                {
                    //var elem = scoresTableHeader.children[i];
                    var elem = extras[i];
                    if (showExtraColumns)
                    {
                        if (elem.style.display == "none")
                        {
                            elem.style.display = "";
                        }
                    }
                    else
                    {
                        if (elem.style.display != "none")
                        {
                            elem.style.display = "none";
                        }
                    }
                }
            }

            function clearSelection(selectObj)
            {
                selectObj.selectedIndex = 0;
                var i;
                for(i = selectObj.options.length - 1; i >= 1; i--)
                {
                    selectObj.remove(i);
                }

                selectObj.disabled = true;
                selectObj.options[0].innerHTML = "";
            }

            function getCompanies()
            {
                if (companiesJSON == null)
                {
                    var xmlhttp = new XMLHttpRequest();
                    xmlhttp.onreadystatechange = function() {
                        if (this.readyState === XMLHttpRequest.DONE) {
                            if (this.status === 200) {
                                companiesJSON = JSON.parse(this.responseText);
                                processCompaniesList();
                            }
                        }
                    };
                    xmlhttp.open("GET", companiesURL, true);
                    xmlhttp.send();
                }
            }

            function processCompaniesList()
            {
                if ((companiesSelectObj != null) && (companiesJSON != null))
                {
                    var search = parseQuery(window.location.search);
                    var selectedCompanyID;
                    var indexToSelect = -1;
                    if ("companyid" in search)
                    {
                        selectedCompanyID = search["companyid"];
                    }

                    for (var i = 0; i < companiesJSON.length; i++) {
                        var obj = companiesJSON[i];
                        companiesMap[obj["id"]] = obj;

                        var opt = document.createElement("option");
                        opt.text = obj["name"];
                        opt.id = obj["id"];
                        companiesSelectObj.add(opt);

                        if (selectedCompanyID == opt.id)
                        {
                            indexToSelect = i + 1;
                        }
                    }

                    if (indexToSelect >= 0)
                    {
                        companiesSelectObj.selectedIndex = indexToSelect;
                        companiesSelectChanged();
                    }
                }
            }

            function getSelectedCompany()
            {
                var id = companiesSelectObj.options[companiesSelectObj.selectedIndex].id;
                var retval = null;

                if (id in companiesMap)
                {
                    retval = companiesMap[id];
                }

                return retval;
            }

            function getSelectedLocation()
            {
                var id = locationSelectObj.options[locationSelectObj.selectedIndex].id;
                var selectedCompany = getSelectedCompany();
                var retval = null;

                if (selectedCompany != null)
                {
                    for (var i = 0; i < selectedCompany["locations"].length; i++)
                    {
                        if (selectedCompany["locations"][i]["id"] == id)
                        {
                            retval = selectedCompany["locations"][i];
                            break;
                        }
                    }
                }

                return retval;
            }

            function getSelectedSeason()
            {
                var id = seasonSelectObj.options[seasonSelectObj.selectedIndex].id;
                var retval = null;

                if (id in seasonsMap)
                {
                    return seasonsMap[id];
                }

                return retval;
            }

            function getSelectedYear()
            {
                var id = yearSelectObj.options[yearSelectObj.selectedIndex].id;
                var retval = null;

                if (id in yearMap)
                {
                    return yearMap[id];
                }

                return retval;
            }

            function companiesSelectChanged()
            {
                clearSelection(locationSelectObj);
                locationSelectChanged(true);

                var company = getSelectedCompany();
                if ((locationSelectObj != null) && (company != null))
                {
                    var search = parseQuery(window.location.search);
                    var selectedLocationID;
                    var indexToSelect = -1;
                    if ("locationid" in search)
                    {
                        selectedLocationID = search["locationid"];
                    }

                    if (company["locations"].length > 0)
                    {
                        locationSelectObj.disabled = false;
                        locationSelectObj.options[0].innerHTML = "Select location...";
                    }
                    else
                    {
                        locationSelectObj.options[0].innerHTML = "No locations available";
                    }

                    for (var i = 0; i < company["locations"].length; i++)
                    {
                        var locObj = company["locations"][i];
                        var opt = document.createElement("option");
                        opt.text = locObj["name"];
                        opt.id = locObj["id"];
                        locationSelectObj.add(opt);

                        if (selectedLocationID == opt.id)
                        {
                            indexToSelect = i + 1;
                        }
                    }

                    if (indexToSelect >= 0)
                    {
                        locationSelectObj.selectedIndex = indexToSelect;
                        locationSelectChanged(true);
                    }
                    else
                    {
                        updateURL();
                        
                        if (locationSelectObj.options.length == 2)
                        {
                            locationSelectObj.selectedIndex = 1;
                            locationSelectChanged();
                        }
                    }
                }
                else if (company == null)
                {
                    updateURL();
                }
            }

            function postToURL(url, postData, resultJSONFunc, resultData)
            {
                var xmlhttp = new XMLHttpRequest();
                xmlhttp.onreadystatechange = function() {
                    if (this.readyState === XMLHttpRequest.DONE) {
                        if (this.status === 200) {
                            var resultJSON = JSON.parse(this.responseText);
                            resultJSONFunc(resultJSON, resultData);
                        }
                        else {
                            resultJSONFunc(null, null);
                        }
                    }
                };
                xmlhttp.open("POST", url, true);
                xmlhttp.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
                xmlhttp.send(postData);
            }

            function locationSelectChanged(fromCode)
            {
                clearSelection(seasonSelectObj);
                seasonSelectChanged(fromCode);

                if (locationSelectObj.selectedIndex > 0)
                {
                    var company = getSelectedLocation();
                    var location = getSelectedLocation();

                    if ((company != null) && (location != null))
                    {
                        var json = JSON.stringify({ "location": location["id"] });
                        postToURL(locationSeasonsURL, json, processSeasonsJSON);
                    }
                }

                if (!fromCode)
                {
                    updateURL();
                }
            }

            function processSeasonsJSON(obj)
            {
                if ((seasonSelectObj != null) && (obj != null))
                {
                    var search = parseQuery(window.location.search);
                    var selectedSeasonID;
                    var indexToSelect = -1;
                    if ("seasonid" in search)
                    {
                        selectedSeasonID = search["seasonid"];
                    }

                    if (obj.length > 0)
                    {
                        seasonSelectObj.disabled = false;
                        seasonSelectObj.options[0].innerHTML = "Select season...";
                    }
                    else
                    {
                        seasonSelectObj.options[0].innerHTML = "No seasons available";
                    }

                    for (var i = 0; i < obj.length; i++)
                    {
                        seasonsMap[obj[i]["id"]] = obj[i];

                        var opt = document.createElement("option");
                        opt.text = obj[i]["name"];
                        opt.id = obj[i]["id"];
                        seasonSelectObj.add(opt);

                        if (selectedSeasonID == opt.id)
                        {
                            indexToSelect = i + 1;
                        }
                    }
                }

                if (indexToSelect >= 0)
                {
                    seasonSelectObj.selectedIndex = indexToSelect;
                    seasonSelectChanged(true);
                }
                else
                {
                    updateURL();

                    if (seasonSelectObj.options.length == 2)
                    {
                        seasonSelectObj.selectedIndex = 1;
                        seasonSelectChanged();
                    }
                }
            }

            function seasonSelectChanged(fromCode)
            {
                clearSelection(yearSelectObj);
                yearSelectChanged(fromCode);

                if (seasonSelectObj.selectedIndex > 0)
                {
                    var location = getSelectedLocation();
                    var season = getSelectedSeason();

                    if ((location != null) && (season != null))
                    {
                        var json = JSON.stringify({ "location": location["id"], "season": season["id"] });
                        postToURL(seasonYearsURL, json, processSeasonYearsJSON);
                    }
                }

                if (!fromCode)
                {
                    updateURL();
                }
            }

            function processSeasonYearsJSON(obj)
            {
                if (obj != null)
                {
                    var search = parseQuery(window.location.search);
                    var selectedYear;
                    var indexToSelect = -1;
                    if ("year" in search)
                    {
                        selectedYear = search["year"];
                    }

                    if (obj.length > 0)
                    {
                        yearSelectObj.disabled = false;
                        yearSelectObj.options[0].innerHTML = "Select year...";
                    }
                    else
                    {
                        yearSelectObj.options[0].innerHTML = "No years available";
                    }

                    for (var i = 0; i < obj.length; i++)
                    {
                        yearMap[obj[i]["year"]] = obj[i];

                        var opt = document.createElement("option");
                        opt.text = obj[i]["year"];
                        opt.id = obj[i]["year"];
                        yearSelectObj.add(opt);

                        if (selectedYear == opt.id)
                        {
                            indexToSelect = i + 1;
                        }
                    }
                }

                if (indexToSelect >= 0)
                {
                    yearSelectObj.selectedIndex = indexToSelect;
                    yearSelectChanged(true);
                }
                else
                {
                    updateURL();

                    if (yearSelectObj.options.length == 2)
                    {
                        yearSelectObj.selectedIndex = 1;
                        yearSelectChanged();
                    }
                }
            }

            function getLocSeasonYearJSON(weekid)
            {
                var retval = "";
                var location = getSelectedLocation();
                var season = getSelectedSeason();
                var year = getSelectedYear();

                if ((location != null) && (season != null) && (year != null))
                {
                    retval = JSON.stringify({ "location": location["id"], "season": season["id"], "year": year["year"], "week": weekid });
                }

                return retval;
            }

            function yearSelectChanged(fromCode)
            {
                playerMap = {};
                weekMap = {};
                var tableRows = scoresTableBody.getElementsByTagName('tr');
                var rowCount = tableRows.length;
                for (var x=rowCount-1; x>=0; x--)
                {
                    var cellCount = scoresTableBody.rows[x].cells.count;
                    for (var y=cellCount-1; y>=0; y--)
                    {
                        scoresTableBody.rows[x].deleteCell(y);
                    }
                    scoresTableBody.deleteRow(x);
                }

                var table = scoresTableHeaderWeek;
                var tableColumns = table.children;
                var columnCount = tableColumns.length;
                var startCol = 0;//startingColumn;
                if (columnCount > 0)
                {
                    for (var x=columnCount-1; x>=startCol; x--)
                    {
                        if (tableColumns[x].classList.contains(weekClassName))
                            table.removeChild(tableColumns[x]);
                    }
                }
                weekColumnHeader.colSpan = 1;

                if (yearSelectObj.selectedIndex > 0)
                {
                    var json = getLocSeasonYearJSON();

                    if ((json != null) && (json.length > 0))
                    {
                        postToURL(leaderboardURL, json, processLeaderboardJSON);
                    }
                }

                if (!fromCode)
                {
                    updateURL();
                }
            }

            function createValueIfNotExist(player, valueName, value)
            {
                if (!(valueName in player))
                {
                    player[valueName] = value;
                }
            }

            function addUpdatePlayer(playerID, playerData)
            {
                var newPlayer = false;
                if (!(playerID in playerMap))
                {
                    playerMap[playerID] = {};
                    newPlayer = true;
                }

                var player = playerMap[playerID];
                var keysList = Object.keys(playerData);
                for (var i = 0; i < keysList.length; i++)
                {
                    var key = keysList[i];
                    var weekNum = playerData["weekNum"];

                    if ((weekNum != null) && (
                        (key == "avg_matches") ||
                        (key == "avg_throws") ||
                        (key == "matches_played") ||
                        (key == "wins") ||
                        (key == "losses")
                        ))
                    {
                        var weekKeyName = key + "_week";
                        if (!(weekKeyName in player))
                        {
                            player[weekKeyName] = {};
                        }
                        player[weekKeyName][weekNum] = playerData[key];
                    }
                    else
                    {
                        player[key] = playerData[key];
                    }

                    if ((key in player) && (playerData[key] != player[key]))
                    {
                        if (key == "points")
                        {
                            console.log("WARNING: Updating field " + key + " for player " + player["name"] + " " + player["lastname"] + ", id=" + playerID + " from " + player[key] + " to " + playerData[key]);
                        }
                    }
                    
                }

                if (!("rowAdded" in player))
                {
                    var row = scoresTableBody.insertRow(-1);

                    createValueIfNotExist(player, "name", "");
                    createValueIfNotExist(player, "lastname", "");
                    createValueIfNotExist(player, "points", 0);
                    createValueIfNotExist(player, "avg_matches", 0);
                    createValueIfNotExist(player, "avg_throws", 0);
                    createValueIfNotExist(player, "matches_played", 0);
                    createValueIfNotExist(player, "wins", 0);
                    createValueIfNotExist(player, "losses", 0);

                    //console.log("Adding rows for player " + player["name"] + " " + player["lastname"] + ", id=" + playerID);

                    var nextCell = 0;
                    var cellStyle = "";
                    var cellInd = -1;

                    const warningColor = "yellow";

                    var cellMap = {};
                    cellMap[(document.getElementById("columnHeaderID") || {}).cellIndex] = {innerHTML: playerID};
                    cellMap[(document.getElementById("columnHeaderNumber") || {}).cellIndex] = {innerHTML: ""};
                    cellMap[(document.getElementById("columnHeaderName") || {}).cellIndex] = {innerHTML: player["name"] + " " + player["lastname"]};
                    cellMap[(document.getElementById("columnHeaderTotalPoints") || {}).cellIndex] = {innerHTML: player["points"]};
                    cellMap[(document.getElementById("columnHeaderAvgMatch") || {}).cellIndex] = {innerHTML: player["avg_matches"], class: customExtraDataName};
                    cellMap[(document.getElementById("columnHeaderAvgThrow") || {}).cellIndex] = {innerHTML: player["avg_throws"], class: customExtraDataName};
                    cellMap[(document.getElementById("columnHeaderMatchesPlayed") || {}).cellIndex] = {innerHTML: player["matches_played"], class: customExtraDataName};
                    cellMap[(document.getElementById("columnHeaderWins") || {}).cellIndex] = {innerHTML: player["wins"], class: customExtraDataName};
                    cellMap[(document.getElementById("columnHeaderLosses") || {}).cellIndex] = {innerHTML: player["losses"], class: customExtraDataName};

                    if (document.getElementById("columnHeaderMatchesPlayed") && ((player["matches_played"] % 4) != 0))
                    {
                        cellMap[document.getElementById("columnHeaderMatchesPlayed").cellIndex].backcolor = warningColor;
                    }

                    if (document.getElementById("columnHeaderWins") &&
                        document.getElementById("columnHeaderLosses") &&
                        (player["wins"] + player["losses"] != player["matches_played"]))
                    {
                        cellMap[document.getElementById("columnHeaderWins").cellIndex].backcolor = warningColor;
                        cellMap[document.getElementById("columnHeaderLosses").cellIndex].backcolor = warningColor;
                    }

                    if (document.getElementById("columnHeaderAvgMatch") &&
                        document.getElementById("columnHeaderAvgThrow") &&
                        (Number(player["avg_matches"]).toFixed(2) !== (Number(player["avg_throws"] * 10.0).toFixed(2))))
                    {
                        cellMap[document.getElementById("columnHeaderAvgMatch").cellIndex].backcolor = warningColor;
                    }

                    var lastKey = -1;
                    var keysList = Object.keys(cellMap).sort();
                    
                    for (var j = 0; j < keysList.length; j++)
                    {
                        var key = keysList[j];
                        if (key !== 'undefined')
                        {
                            // Skip unused columns
                            while ((key - 1) > lastKey)
                            {
                                var td_blank = row.insertCell(nextCell++);
                                lastKey++;
                            }

                            var disp = scoresTableHeader.cells[key].style.display;
                            var td = row.insertCell(nextCell++);
                            td.innerHTML = cellMap[key].innerHTML;

                            if ((disp != null) && (disp != ""))
                            {
                                td.style.display = disp;
                            }
                            if (cellMap[key].backcolor != null)
                            {
                                td.style["background-color"] = cellMap[key].backcolor;
                            }
                            if (cellMap[key].class != null)
                            {
                                td.className = td.className += (td.className ? " " : "") + cellMap[key].class;
                            }
                        }

                        lastKey = key;
                    }

                    player["rowAdded"] = true;
                }

                if (!("weekCellsCreated" in player))
                {
                    if ((weekMap != null) && Object.keys(weekMap).length > 0)
                    {
                        //console.log("Adding " + Object.keys(weekMap).length + " week cells for player " + player["name"] + " " + player["lastname"] + ", id=" + playerID);
                        Object.keys(weekMap).forEach(function(key) {
                            //var test;
                            var rowIndex = getPlayerRowIndex(playerID);
                            if (rowIndex >= 0)
                            {
                                scoresTableBody.rows[rowIndex].insertCell(-1).innerHTML = "-";
                            }
                        });

                        player["weekCellsCreated"] = true;
                    }
                }
            }

            function processLeaderboardJSON(obj)
            {
                if (obj != null)
                {
                    for (var i=0; i < obj.length; i++)
                    {
                        var playerData = obj[i];
                        var playerID = playerData["player_id"];
                        addUpdatePlayer(playerID, playerData);
                    }
                }

                renumberRows(true);

                var json = getLocSeasonYearJSON();
                if ((json != null) && (json.length > 0))
                {
                    postToURL(locationWeeksURL, json, processWeeksJSON);
                }
            }

            function processWeeksJSON(obj)
            {
                var nextCell = 5;

                if (obj != null)
                {
                    //obj.sort(function(a, b) { return a["id"] < b["id"]; });
                    //for (var i = obj.length-1; i >= 0; i--)
                    weekColumnHeader.colSpan = obj.length;
                    for (var i = 0; i < obj.length; i++)
                    {
                        var week = weekOrderHighLow ? obj[i] : obj[obj.length-1-i];
                        weekMap[week["id"]] = week;
                        var elem = document.createElement("th");
                        elem.classList.add(weekClassName);
                        elem.classList.add("th-lower");
                        elem.innerHTML = week["number"];
                        var ch = scoresTableHeaderWeek.appendChild(elem);
                        week["cellIndex"] = ch.cellIndex + startingColumn;
                        elem.setAttribute("onclick", "sortTable("+week["cellIndex"]+")");
                    }

                    Object.keys(weekMap).forEach(function(key) {
                        var id = key;
                        var value = weekMap[key];
                        var json = getLocSeasonYearJSON(id);
                        if ((json != null) && (json.length > 0))
                        {
                            postToURL(locByWeeksURL, json, processWeekScores, id);
                        }
                    });
                }
            }

            function getPlayerRowIndex(playerID)
            {
                var retval = -1;
                var cellIndex = document.getElementById("columnHeaderID").cellIndex;

                for (var i = 0; i < scoresTableBody.rows.length; i++)
                {
                    if (Number(scoresTableBody.rows[i].cells[cellIndex].innerHTML) == playerID)
                    {
                        return i;
                    }
                }

                return -1;
            }

            function processWeekScores(obj, id)
            {
                if (obj != null)
                {
                    for (var i = 0; i < obj.length; i++)
                    {
                        var scoreObj = obj[i];
                        var cellIndex = weekMap[id]["cellIndex"];
                        var weekNum = weekMap[id]["number"];
                        var playerID = scoreObj["player_id"];
                        scoreObj["weekNum"] = weekNum;
                        addUpdatePlayer(playerID, scoreObj);
                        
                        var player = playerMap[playerID];
                        if (player != null)
                        {
                            var rowIndex = getPlayerRowIndex(playerID);
                            if (rowIndex >= 0)
                            {
                                var cell = scoresTableBody.rows[rowIndex].cells[cellIndex];

                                //console.log("Adding score of " + scoreObj["week_points"] + " to player " + player["name"] + " " + player["lastname"] + ", week " + weekNum + ", id=" + playerID + ", rowIndex=" + rowIndex + ", cellIndex=" + cellIndex);

                                cell.innerHTML = scoreObj["week_points"];
                                if (!("wk17Points" in player))
                                {
                                    player["wk17Points"] = 0;
                                }
                                
                                if ((weekNum >= 1) && (weekNum <= 7))
                                {
                                    player["wk17Points"] += Number(scoreObj["week_points"]);
                                }

                                var wk17TH = document.getElementById("columnHeaderWeek17Points");
                                if (wk17TH != null)
                                {
                                    var wk17CellIndex = wk17TH.cellIndex;
                                    var cell = scoresTableBody.rows[rowIndex].cells[wk17CellIndex];
                                    cell.innerHTML = player["wk17Points"];
                                }
                            }
                        }
                    }
                }

                //lastColSortAsc = false;
                sortTableByID(document.getElementById("columnHeaderTotalPoints"), false, false);
            }

            function sortTableByID(idName, isText, forceascdesc = null)
            {
                //var elem = document.getElementById(idName);

                if (idName != null)
                {
                    sortTable(idName.cellIndex, isText, forceascdesc);
                }
            }

            var lastColSortNum = -1;
            var lastColSortAsc = true;

            function sortTable(n, isText, forceascdesc = null) 
            {
                var table, rows, switching, i, x, y, shouldSwitch, switchcount = 0;
                table = document.getElementById("scoresTableBody");
                switching = true;

                if (forceascdesc == null)
                {
                    var asc = isText ? true : false;
                    if (lastColSortNum == n)
                        asc = lastColSortAsc ? false : true;

                    lastColSortNum = n;
                    lastColSortAsc = asc;
                }
                else
                {
                    asc = forceascdesc;
                }
                
                /* Make a loop that will continue until
                no switching has been done: */
                while (switching) {
                    // Start by saying: no switching is done:
                    switching = false;
                    rows = table.rows;
                    /* Loop through all table rows (except the
                    first, which contains table headers): */
                    for (i = 0; i < (rows.length - 1); i++) {
                        // Start by saying there should be no switching:
                        shouldSwitch = false;
                        /* Get the two elements you want to compare,
                        one from current row and one from the next: */
                        x = rows[i].getElementsByTagName("TD")[n];
                        y = rows[i + 1].getElementsByTagName("TD")[n];
                        /* Check if the two rows should switch place,
                        based on the direction, asc or desc: */
                        if (asc) {
                            if (((isText) &&
                                (x.innerHTML.toLowerCase() > y.innerHTML.toLowerCase())) ||
                                (Number(x.innerHTML) > Number(y.innerHTML))) {
                                // If so, mark as a switch and break the loop:
                                shouldSwitch = true;
                                break;
                            }
                        } else {
                            if (((isText) &&
                                (x.innerHTML.toLowerCase() < y.innerHTML.toLowerCase())) ||
                                (Number(x.innerHTML) < Number(y.innerHTML))) {
                                // If so, mark as a switch and break the loop:
                                shouldSwitch = true;
                                break;
                            }
                        }
                    }
                    if (shouldSwitch) {
                        /* If a switch has been marked, make the switch
                        and mark that a switch has been done: */
                        rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
                        switching = true;
                        // Each time a switch is done, increase this count by 1:
                        switchcount++;
                    } else {
                        /* If no switching has been done AND the direction is "asc",
                        set the direction to "desc" and run the while loop again. */
                        if (switchcount == 0 && asc) {
                            asc = false;
                            switching = true;
                        }
                    }
                }

                renumberRows(isText ? asc : !asc);
            }

            function renumberRows(asc)
            {
                var table = document.getElementById("scoresTableBody");
                var rows = table.rows;
                if (document.getElementById("columnHeaderNumber") != null)
                {
                    var colnum = document.getElementById("columnHeaderNumber").cellIndex;

                    for (i = 0; i < rows.length; i++) {
                        var row = rows[i];
                        var num = asc ? i + 1 : rows.length - i;
                        row.cells[colnum].innerHTML = num;
                    }
                }
            }

            function flipWeekOrder()
            {
                weekOrderHighLow = !weekOrderHighLow;
                updateURL();
                companiesSelectChanged();
            }

            function toggleExtraColumns()
            {
                showExtraColumns = !showExtraColumns;
                updateURL();
                //companiesSelectChanged();
                showHideExtraColumns();
            }
            
        </script>
    </head>
    <body onload="onBodyLoad()">
        <div class="container-fluid extra-bottom-padding" id="selectors">
            <div class="col">
                <div class="form-inline">
                    <select class="form-control" id="companiesSelect" onchange="companiesSelectChanged()">
                        <option text="Select company">Select company...</option>
                    </select>
                    <select class="form-control" id="locationSelect" onchange="locationSelectChanged()" disabled>
                        <option text="Select location"></option>
                    </select>
                    <select class="form-control" id="seasonSelect" onchange="seasonSelectChanged()" disabled>
                        <option text="Select season"></option>
                    </select>
                    <select class="form-control" id="yearSelect" onchange="yearSelectChanged()" disabled>
                        <option text="Select year"></option>
                    </select>
                </div>
            </div>
        </div>
        <div class="container-fluid tableFixHead" id="mainTableDIV">
            <table class="table table-striped" id="scoresTable">
                <thead>
                    <tr id="scoresTableHeader">
                        <th rowSpan="2" id="columnHeaderNumber">#</th>
                        <th rowSpan="2" style="display:none" id="columnHeaderID">ID</th>
                        <th rowSpan="2" id="columnHeaderName" onclick="sortTableByID(columnHeaderName, true)">Name</th>
                        <th rowSpan="2" id="columnHeaderTotalPoints" onclick="sortTableByID(columnHeaderTotalPoints)">Total Points</th>
                        <th rowSpan="2" id="columnHeaderWeek17Points" onclick="sortTableByID(columnHeaderWeek17Points)">Wk1-7 Points</th>
                        <th rowspan="2" class="customExtraData" style="display:none" id="columnHeaderAvgMatch" onclick="sortTableByID(columnHeaderAvgMatch)">Avg. Match</th>
                        <th rowspan="2" class="customExtraData" style="display:none" id="columnHeaderAvgThrow" onclick="sortTableByID(columnHeaderAvgThrow)">Avg. Throw</th>
                        <th rowspan="2" class="customExtraData" style="display:none" id="columnHeaderMatchesPlayed" onclick="sortTableByID(columnHeaderMatchesPlayed)">Matches Played</th>
                        <th rowspan="2" class="customExtraData" style="display:none" id="columnHeaderWins" onclick="sortTableByID(columnHeaderWins)">Wins</th>
                        <th rowspan="2" class="customExtraData" style="display:none" id="columnHeaderLosses" onclick="sortTableByID(columnHeaderLosses)">Losses</th>
                        <th colSpan="0" style="text-align:center" id="weekColumnHeader" onclick="toggleExtraColumns()">Week</th>
                    </tr>
                    <tr id="scoresTableHeaderWeek">
                    </tr>
                    </thead>
                <tbody id="scoresTableBody">
                </tbody>
            </table>
        </div>
    </body>
</html>