<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="description" content="WATL Leaderboards">
        <meta name="author" content="">

        <title>WATL Leaderboards</title>

        <!-- Bootstrap -->
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha384-HSMxcRTRxnN+Bdg0JdbxYKrThecOKuH5zCYotlSAcp1+c8xmyTe9GYg1l9a69psu" crossorigin="anonymous">

        <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
        <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
        <![endif]-->
        <script>
            var baseURL = "https://app.worldaxethrowingleague.com/api/";
            var leaderboardURL = baseURL + "player-leaderboard";
            var companiesURL = baseURL + "companies";
            var locationSeasonsURL = baseURL + "location-seasons";
            var seasonYearsURL = baseURL + "season-years";
            var locationWeeksURL = baseURL + "location-weeks";
            var locByWeeksURL = baseURL + "player-leaderboard-info-by-weeks";

            var companiesJSON;
            var companiesMap = {};
            var seasonsMap = {};
            var yearMap = {};
            var playerMap = {};
            var weekMap = {};

            var companiesSelectObj;
            var locationSelectObj;
            var seasonSelectObj;
            var yearSelectObj;
            var scoresTable;
            var startingColumn;

            function parseQuery(search)
            {
                var args = search.substring(1).split('&');
                var argsParsed = {};
                var i, arg, kvp, key, value;

                for (i=0; i < args.length; i++) {
                    arg = args[i];
                    if (-1 === arg.indexOf('=')) {
                        argsParsed[decodeURIComponent(arg).trim()] = true;
                    }
                    else {
                        kvp = arg.split('=');
                        key = decodeURIComponent(kvp[0]).trim();
                        value = decodeURIComponent(kvp[1]).trim();
                        argsParsed[key] = value;
                    }
                }

                return argsParsed;
            }

            function buildQuery()
            {
                var queryString = "";
                var retval = "";

                var selectedCompany = getSelectedCompany();
                if (selectedCompany != null)
                {
                    queryString = queryString.concat((queryString.length > 0 ? "&" : "") + "companyid="+selectedCompany["id"]);
                }

                var selectedLocation = getSelectedLocation();
                if (selectedLocation != null)
                {
                    queryString = queryString.concat((queryString.length > 0 ? "&" : "") + "locationid="+selectedLocation["id"]);
                }

                var selectedSeason = getSelectedSeason();
                if (selectedSeason != null)
                {
                    queryString = queryString.concat((queryString.length > 0 ? "&" : "") + "seasonid="+selectedSeason["id"]);
                }

                var selectedYear = getSelectedYear();
                if (selectedYear != null)
                {
                    queryString = queryString.concat((queryString.length > 0 ? "&" : "") + "year="+selectedYear["year"]);
                }

                if (queryString.length > 0)
                {
                    retval = "?" + queryString;
                }

                return retval;
            }

            function buildFullURL()
            {
                return window.location.origin + window.location.pathname + buildQuery();
            }

            function updateURL()
            {
                window.history.replaceState({}, 'Leaderboards', buildFullURL());
            }

            function onBodyLoad()
            {
                scoresTable = document.getElementById("scoresTable");
                companiesSelectObj = document.getElementById("companiesSelect");
                locationSelectObj = document.getElementById("locationSelect");
                seasonSelectObj = document.getElementById("seasonSelect");
                yearSelectObj = document.getElementById("yearSelect");
                startingColumn = scoresTable.rows[0].children.length;

                getCompanies();
            }

            function clearSelection(selectObj)
            {
                selectObj.selectedIndex = 0;
                for (i = 1; i < selectObj.options.length; i++) {
                    selectObj.options[i] = null;
                }
            }

            function getCompanies()
            {
                if (companiesJSON == null)
                {
                    var xmlhttp = new XMLHttpRequest();
                    xmlhttp.onreadystatechange = function() {
                        if (this.readyState === XMLHttpRequest.DONE) {
                            if (this.status === 200) {
                                companiesJSON = JSON.parse(this.responseText);
                                processCompaniesList();
                            }
                        }
                    };
                    xmlhttp.open("GET", companiesURL, true);
                    xmlhttp.send();
                }
            }

            function processCompaniesList()
            {
                if ((companiesSelectObj != null) && (companiesJSON != null))
                {
                    var search = parseQuery(window.location.search);
                    var selectedCompanyID;
                    var indexToSelect = -1;
                    if ("companyid" in search)
                    {
                        selectedCompanyID = search["companyid"];
                    }

                    for (var i = 0; i < companiesJSON.length; i++) {
                        var obj = companiesJSON[i];
                        companiesMap[obj["id"]] = obj;

                        var opt = document.createElement("option");
                        opt.text = obj["name"];
                        opt.id = obj["id"];
                        companiesSelectObj.add(opt);

                        if (selectedCompanyID == opt.id)
                        {
                            indexToSelect = i + 1;
                        }
                    }

                    if (indexToSelect >= 0)
                    {
                        companiesSelectObj.selectedIndex = indexToSelect;
                        companiesSelectChanged();
                    }
                }
            }

            function getSelectedCompany()
            {
                var id = companiesSelectObj.options[companiesSelectObj.selectedIndex].id;
                var retval = null;

                if (id in companiesMap)
                {
                    retval = companiesMap[id];
                }

                return retval;
            }

            function getSelectedLocation()
            {
                var id = locationSelectObj.options[locationSelectObj.selectedIndex].id;
                var selectedCompany = getSelectedCompany();
                var retval = null;

                if (selectedCompany != null)
                {
                    for (var i = 0; i < selectedCompany["locations"].length; i++)
                    {
                        if (selectedCompany["locations"][i]["id"] == id)
                        {
                            retval = selectedCompany["locations"][i];
                            break;
                        }
                    }
                }

                return retval;
            }

            function getSelectedSeason()
            {
                var id = seasonSelectObj.options[seasonSelectObj.selectedIndex].id;
                var retval = null;

                if (id in seasonsMap)
                {
                    return seasonsMap[id];
                }

                return retval;
            }

            function getSelectedYear()
            {
                var id = yearSelectObj.options[yearSelectObj.selectedIndex].id;
                var retval = null;

                if (id in yearMap)
                {
                    return yearMap[id];
                }

                return retval;
            }

            function companiesSelectChanged()
            {
                clearSelection(locationSelectObj);
                locationSelectChanged(true);

                var company = getSelectedCompany();
                if ((locationSelectObj != null) && (company != null))
                {
                    var search = parseQuery(window.location.search);
                    var selectedLocationID;
                    var indexToSelect = -1;
                    if ("locationid" in search)
                    {
                        selectedLocationID = search["locationid"];
                    }

                    for (var i = 0; i < company["locations"].length; i++)
                    {
                        var locObj = company["locations"][i];
                        var opt = document.createElement("option");
                        opt.text = locObj["name"];
                        opt.id = locObj["id"];
                        locationSelectObj.add(opt);

                        if (selectedLocationID == opt.id)
                        {
                            indexToSelect = i + 1;
                        }
                    }

                    if (indexToSelect >= 0)
                    {
                        locationSelectObj.selectedIndex = indexToSelect;
                        locationSelectChanged(true);
                    }
                    else
                    {
                        updateURL();
                        
                        if (locationSelectObj.options.length == 2)
                        {
                            locationSelectObj.selectedIndex = 1;
                            locationSelectChanged();
                        }
                    }
                }
            }

            function postToURL(url, postData, resultJSONFunc, resultData)
            {
                var xmlhttp = new XMLHttpRequest();
                xmlhttp.onreadystatechange = function() {
                    if (this.readyState === XMLHttpRequest.DONE) {
                        if (this.status === 200) {
                            var resultJSON = JSON.parse(this.responseText);
                            resultJSONFunc(resultJSON, resultData);
                        }
                    }
                };
                xmlhttp.open("POST", url, true);
                xmlhttp.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
                xmlhttp.send(postData);
            }

            function locationSelectChanged(fromCode)
            {
                clearSelection(seasonSelectObj);
                seasonSelectChanged(fromCode);

                if (locationSelectObj.selectedIndex > 0)
                {
                    var company = getSelectedLocation();
                    var location = getSelectedLocation();

                    if ((company != null) && (location != null))
                    {
                        var json = JSON.stringify({ "location": location["id"] });
                        postToURL(locationSeasonsURL, json, processSeasonsJSON);
                    }
                }

                if (!fromCode)
                {
                    updateURL();
                }
            }

            function processSeasonsJSON(obj)
            {
                if ((seasonSelectObj != null) && (obj != null))
                {
                    var search = parseQuery(window.location.search);
                    var selectedSeasonID;
                    var indexToSelect = -1;
                    if ("seasonid" in search)
                    {
                        selectedSeasonID = search["seasonid"];
                    }

                    for (var i = 0; i < obj.length; i++)
                    {
                        seasonsMap[obj[i]["id"]] = obj[i];

                        var opt = document.createElement("option");
                        opt.text = obj[i]["name"];
                        opt.id = obj[i]["id"];
                        seasonSelectObj.add(opt);

                        if (selectedSeasonID == opt.id)
                        {
                            indexToSelect = i + 1;
                        }
                    }
                }

                if (indexToSelect >= 0)
                {
                    seasonSelectObj.selectedIndex = indexToSelect;
                    seasonSelectChanged(true);
                }
                else
                {
                    updateURL();

                    if (seasonSelectObj.options.length == 2)
                    {
                        seasonSelectObj.selectedIndex = 1;
                        seasonSelectChanged();
                    }
                }
            }

            function seasonSelectChanged(fromCode)
            {
                clearSelection(yearSelectObj);
                yearSelectChanged(fromCode);

                if (seasonSelectObj.selectedIndex > 0)
                {
                    var location = getSelectedLocation();
                    var season = getSelectedSeason();

                    if ((location != null) && (season != null))
                    {
                        var json = JSON.stringify({ "location": location["id"], "season": season["id"] });
                        postToURL(seasonYearsURL, json, processSeasonYearsJSON);
                    }
                }

                if (!fromCode)
                {
                    updateURL();
                }
            }

            function processSeasonYearsJSON(obj)
            {
                if (obj != null)
                {
                    var search = parseQuery(window.location.search);
                    var selectedYear;
                    var indexToSelect = -1;
                    if ("year" in search)
                    {
                        selectedYear = search["year"];
                    }

                    for (var i = 0; i < obj.length; i++)
                    {
                        yearMap[obj[i]["year"]] = obj[i];

                        var opt = document.createElement("option");
                        opt.text = obj[i]["year"];
                        opt.id = obj[i]["year"];
                        yearSelectObj.add(opt);

                        if (selectedYear == opt.id)
                        {
                            indexToSelect = i + 1;
                        }
                    }
                }

                if (indexToSelect >= 0)
                {
                    yearSelectObj.selectedIndex = indexToSelect;
                    yearSelectChanged(true);
                }
                else
                {
                    updateURL();

                    if (yearSelectObj.options.length == 2)
                    {
                        yearSelectObj.selectedIndex = 1;
                        yearSelectChanged();
                    }
                }
            }

            function getLocSeasonYearJSON(weekid)
            {
                var retval = "";
                var location = getSelectedLocation();
                var season = getSelectedSeason();
                var year = getSelectedYear();

                if ((location != null) && (season != null) && (year != null))
                {
                    retval = JSON.stringify({ "location": location["id"], "season": season["id"], "year": year["year"], "week": weekid });
                }

                return retval;
            }

            function yearSelectChanged(fromCode)
            {
                playerMap = {};
                var tableRows = scoresTable.getElementsByTagName('tr');
                var rowCount = tableRows.length;
                for (var x=rowCount-1; x>0; x--)
                {
                    scoresTable.deleteRow(x);
                }

                var tableColumns = scoresTable.rows[0].children;
                var columnCount = tableColumns.length;
                for (var x=columnCount-1; x>=startingColumn; x--)
                {
                    scoresTable.rows[0].removeChild(tableColumns[x]);
                }

                if (yearSelectObj.selectedIndex > 0)
                {
                    var json = getLocSeasonYearJSON();

                    if ((json != null) && (json.length > 0))
                    {
                        postToURL(leaderboardURL, json, processLeaderboardJSON);
                    }
                }

                if (!fromCode)
                {
                    updateURL();
                }
            }

            function processLeaderboardJSON(obj)
            {
                var table = document.getElementById("scoresTable");
                if ((table != null) && (obj != null))
                {
                    for (var i=0; i < obj.length; i++)
                    {
                        var player = obj[i];
                        playerMap[player["player_id"]] = player;

                        var row = table.insertRow(-1);
                        player["rowIndex"] = row.rowIndex;
                        var nextCell = 0;
                        row.insertCell(nextCell++).innerHTML = i+1;
                        row.insertCell(nextCell++).innerHTML = player["name"] + " " + player["lastname"];
                        row.insertCell(nextCell++).innerHTML = player["points"];
                        //row.insertCell(nextCell++).innerHTML = player["avg_matches"];
                        //row.insertCell(nextCell++).innerHTML = player["avg_throws"];
                    }
                }

                var json = getLocSeasonYearJSON();
                if ((json != null) && (json.length > 0))
                {
                    postToURL(locationWeeksURL, json, processWeeksJSON);
                }
            }

            function processWeeksJSON(obj)
            {
                var table = document.getElementById("scoresTable");
                var nextCell = 5;

                if ((table != null) && (obj != null))
                {
                    //obj.sort(function(a, b) { return a["id"] < b["id"]; });
                    for (var i = obj.length-1; i >= 0; i--)
                    {
                        var week = obj[i];
                        weekMap[week["id"]] = week;

                        var elem = document.createElement("th");
                        elem.innerHTML = "Wk. " + week["number"];
                        var ch = table.rows[0].appendChild(elem);
                        elem.setAttribute("onclick", "sortTable("+ch.cellIndex+")");
                        week["cellIndex"] = ch.cellIndex;

                        Object.keys(playerMap).forEach(function(key) {
                            var player = playerMap[key];
                            table.rows[player["rowIndex"]].insertCell(-1).innerHTML = "-";
                        });
                    }

                    Object.keys(weekMap).forEach(function(key) {
                        var id = key;
                        var value = weekMap[key];
                        var json = getLocSeasonYearJSON(id);
                        if ((json != null) && (json.length > 0))
                        {
                            postToURL(locByWeeksURL, json, processWeekScores, id);
                        }
                    });
                }
            }

            function processWeekScores(obj, id)
            {
                var table = document.getElementById("scoresTable");
                if ((table != null) && (obj != null))
                {
                    for (var i = 0; i < obj.length; i++)
                    {
                        var scoreObj = obj[i];
                        var cellIndex = weekMap[id]["cellIndex"];
                        if (scoreObj["player_id"] in playerMap)
                        {
                            var player = playerMap[scoreObj["player_id"]];
                            var rowIndex = player["rowIndex"];
                            if (player != null)
                            {
                                var cell = table.rows[rowIndex].cells[cellIndex];
                                cell.innerHTML = scoreObj["week_points"];
                            }
                        }
                    }
                }
            }

            function sortTable(n, isText) 
            {
                var table, rows, switching, i, x, y, shouldSwitch, dir, switchcount = 0;
                table = document.getElementById("scoresTable");
                switching = true;
                // Set the sorting direction to ascending:
                dir = isText ? "asc" : "desc";
                /* Make a loop that will continue until
                no switching has been done: */
                while (switching) {
                    // Start by saying: no switching is done:
                    switching = false;
                    rows = table.rows;
                    /* Loop through all table rows (except the
                    first, which contains table headers): */
                    for (i = 1; i < (rows.length - 1); i++) {
                        // Start by saying there should be no switching:
                        shouldSwitch = false;
                        /* Get the two elements you want to compare,
                        one from current row and one from the next: */
                        x = rows[i].getElementsByTagName("TD")[n];
                        y = rows[i + 1].getElementsByTagName("TD")[n];
                        /* Check if the two rows should switch place,
                        based on the direction, asc or desc: */
                        if (dir == "asc") {
                            if (((isText) &&
                                (x.innerHTML.toLowerCase() > y.innerHTML.toLowerCase())) ||
                                (Number(x.innerHTML) > Number(y.innerHTML))) {
                                // If so, mark as a switch and break the loop:
                                shouldSwitch = true;
                                break;
                            }
                        } else if (dir == "desc") {
                            if (((isText) &&
                                (x.innerHTML.toLowerCase() < y.innerHTML.toLowerCase())) ||
                                (Number(x.innerHTML) < Number(y.innerHTML))) {
                                // If so, mark as a switch and break the loop:
                                shouldSwitch = true;
                                break;
                            }
                        }
                    }
                    if (shouldSwitch) {
                        /* If a switch has been marked, make the switch
                        and mark that a switch has been done: */
                        rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
                        switching = true;
                        // Each time a switch is done, increase this count by 1:
                        switchcount++;
                    } else {
                        /* If no switching has been done AND the direction is "asc",
                        set the direction to "desc" and run the while loop again. */
                        if (switchcount == 0 && dir == "asc") {
                            dir = "desc";
                            switching = true;
                        }
                    }
                }
            }
            
        </script>
    </head>
    <body onload="onBodyLoad()">
        <div id="selectors">
            <div class="form-inline">
                <select class="form-control" id="companiesSelect" onchange="companiesSelectChanged()">
                    <option text="Select company"></option>
                </select>
                <select class="form-control" id="locationSelect" onchange="locationSelectChanged()">
                    <option text="Select location"></option>
                </select>
                <select class="form-control" id="seasonSelect" onchange="seasonSelectChanged()">
                    <option text="Select season"></option>
                </select>
                <select class="form-control" id="yearSelect" onchange="yearSelectChanged()">
                    <option text="Select year"></option>
                </select>
            </div>
        </div>
        <div id="mainTableDIV">
            <table class="table table-striped" id="scoresTable">
                <tbody>
                    <tr>
                        <th onclick="sortTable(2)">#</th>
                        <th onclick="sortTable(1, true)">Name</th>
                        <th onclick="sortTable(2)">Total Points</th>
                        <!--
                        <th onclick="sortTable(3)">Avg. Match</th>
                        <th onclick="sortTable(4)">Avg. Throw</th>
                        -->
                    </tr>
                </tbody>
            </table>
        </div>
    </body>
</html>